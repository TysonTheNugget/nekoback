<html>
<head>
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
 <title>Usagis Place</title>




 <script src="/static/js/sats-connect-bundle.js"></script>
    <script src="/static/js/fun.js"></script>

  <script> 
 let selectedBase64Image = "";
    
    function fetchRandomImageAndConvertToBase64() {
  const img = document.getElementById("randomImage");
  fetch(img.src)
    .then(response => response.blob())
    .then(blob => {
      const reader = new FileReader();
      reader.onload = function() {
        // Get the base64 string without the data URI prefix
        const base64Image = reader.result.split(',')[1];
        
        // Perform the inscription logic here using base64Image
        // For example, you can call a function to initiate inscription with base64Image
        
        // You can also display an alert or perform any other actions
        alert("Image selected for inscription.");
      }
      reader.readAsDataURL(blob);
    });
}

function randomizeImage() {
  var imgElement = document.getElementById("randomImage");
  imgElement.style.animation = 'none';  // Reset animation
  setTimeout(function() {
    imgElement.style.animation = '';  // Trigger animation
  }, 10);
  // Your existing code to change image
}

    function randomizeImage() {
        fetch('/randomize', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            let uniqueTimestamp = new Date().getTime();
            document.getElementById('randomImage').src = data.imageUrl + '?' + uniqueTimestamp;
            document.getElementById('imageInfo').textContent = "Background: " + data.imageInfo.background +
            "\nBody: " + data.imageInfo.body + "\nBoost: " + data.imageInfo.boost + "\nMouth: " + data.imageInfo.mouth +
            "\nEyes: " + data.imageInfo.eyes + "\nFace: " + data.imageInfo.face + "\nBUN$/PB holdings: " + data.imageInfo.holdings +
            "\nATK: " + data.imageInfo.atk + " DEF: " + data.imageInfo.def + " SPEED: " + data.imageInfo.speed + " HP: +" + data.imageInfo.hp +
            "\nEffect: " + data.imageInfo.effect;
            document.getElementById('imageInfo').textContent += "\nFight Code: " + data.imageInfo.fightCode;
         

      });
    }

document.addEventListener('DOMContentLoaded', function() {
  const contentDiv = document.getElementById('addressDisplay');
  
  function saveText() {
    // Capturing the content inside the 'addressDisplay' div
    const addressDisplayContent = contentDiv.innerText;

    // Capturing the content inside the 'display-address' div
    const displayAddressContent = document.getElementById('display-address').innerText;

    // Capturing the text content inside the 'imageInfo' pre element
    const imageInfoContent = document.getElementById('imageInfo').innerText;

    // Sending captured content to the server
    fetch("/save", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ 
        addressDisplayContent: addressDisplayContent, 
        displayAddressContent: displayAddressContent,
        imageInfoContent: imageInfoContent
      })
    }).then(response => {
      if (response.ok) {
        console.log("Content saved successfully.");
      } else {
        console.log("Error saving content.");
      }
    });
  }

  // Only proceed if contentDiv actually exists
  if (contentDiv) {
    const observer = new MutationObserver(function() {
      const contentText = contentDiv.innerText;
      if (contentText.includes('Transaction ID')) {
        saveText();
      }
    });
    
    observer.observe(contentDiv, { childList: true, subtree: true });
  }
});


   async function sendToMongoDB() {
  const imageInfoText = document.getElementById('imageInfo').textContent;
  const lines = imageInfoText.split('\n');
  const imageInfo = {
    background: lines[0].split(': ')[1],
    body: lines[1].split(': ')[1],
    boost: lines[2].split(': ')[1],
    mouth: lines[3].split(': ')[1],
    eyes: lines[4].split(': ')[1],
    face: lines[5].split(': ')[1],
    holdings: lines[6].split(': ')[1],
    atk: lines[7].split(' ')[1],
    def: lines[7].split(' ')[3],
    speed: lines[7].split(' ')[5],
    hp: lines[7].split(' ')[7],
    effect: lines[8].split(': ')[1],
    fightCode: lines[9].split(': ')[1]
  };
  
  // Call sendDataToMongoDB function and pass it imageInfo and the endpoint
  sendDataToMongoDB(imageInfo, '/save_to_mongodb'); // <-- Add this line inside the function
}
  
      
    async function fetchOrderData() {
        const orderId = document.getElementById('orderIdInput').value;
        if (!orderId) {
            alert('Please enter an Order ID.');
            return;
        }
       fetch(`/proxy_fetch/${orderId}`, {
    method: 'GET'
})
.then(response => response.json())
.then(data => {
    console.log(data);
})
.catch(error => {
    console.error('An error occurred:', error);
});
    }
    </script>
   
  
</head>
<body>
<div id="container">

  <!-- For the top right button -->
  <button id="get-address-button">Xverse Connect</button>

  <!-- Main content centered -->
  <div id="main-content">
    <img id="randomImage" src="/static/default.png" alt="Random Image" width="315" height="240">
  </div>

  <!-- Bottom buttons and warning -->
  <div id="bottom-section">
    <button onclick="randomizeImage()">Randomize</button>
    <button onclick="selectToInscribe()">Select to Inscribe</button>
    <button id="inscribeButton">Inscribe</button>
    <div class="warning">
      Stay on this page until the transaction ID shows!
    </div>
<h1 style="font-size: 24px;">Inscribed: 777\ <span id="inscribed">0</span></h1>
<a href="https://magiceden.io/ordinals/marketplace/usagis" target="_blank" style="color: fuchsia; text-decoration: none; font-weight: bold; font-size: 18px; border-bottom: 2px solid fuchsia;">
  Visit MagicEden Marketplace
</a>
  </div>

  <!-- Bottom left traits info -->
  <pre id="imageInfo">Traits will appear here.</pre>

  <!-- Other existing content, no change -->
  <hr>
  <div id="addressDisplay"></div>
  <div id="display-address"></div>
  <div id="result"></div>
  <pre id="receipt"></pre>
</div> 
</body>
</html>