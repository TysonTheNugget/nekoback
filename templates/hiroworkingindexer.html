<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Ordinals Lookup</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-4xl">
        <h1 class="text-2xl font-bold mb-4 text-center">Bitcoin Ordinals Lookup</h1>
        <div class="mb-4">
            <label for="address" class="block text-sm font-medium text-gray-700">Enter Bitcoin Address:</label>
            <input type="text" id="address" placeholder="e.g., bc1pxaneaf3w4d27hl2y93fuft2xk6m4u3wc4rafevc6slgd7f5tq2dqynekta" class="mt-1 p-2 w-full border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <button onclick="fetchAllOrdinals()" class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600">Search Ordinals</button>
        <div id="results" class="mt-6"></div>
    </div>

    <script>
        async function fetchAllOrdinals() {
            const address = document.getElementById('address').value.trim();
            const resultsDiv = document.getElementById('results');
            const limit = 60; // API default limit per page
            let offset = 0;
            let allInscriptions = [];

            if (!address) {
                resultsDiv.innerHTML = '<p class="text-red-500">Please enter a valid Bitcoin address.</p>';
                return;
            }

            // Load the JSON file
            let jsonIds = [];
            try {
                const response = await fetch('clean_inscriptions.json');
                if (!response.ok) {
                    throw new Error(`Failed to load clean_inscriptions.json: HTTP status ${response.status}`);
                }
                const jsonData = await response.json();
                console.log('Raw JSON data:', jsonData); // Debugging: Log raw JSON

                // Verify jsonData is an array
                if (!Array.isArray(jsonData)) {
                    throw new Error(`clean_inscriptions.json is not an array. Received type: ${typeof jsonData}`);
                }

                // Extract unique IDs, ensuring each item has an 'id' property
                jsonIds = [...new Set(jsonData
                    .filter(item => item && typeof item === 'object' && 'id' in item)
                    .map(item => item.id))];
                if (jsonIds.length === 0) {
                    throw new Error('No valid inscription IDs found in clean_inscriptions.json');
                }
                console.log(`Loaded ${jsonIds.length} unique IDs from clean_inscriptions.json:`, jsonIds); // Debugging

                // Check if the target inscription ID is in the JSON
                const targetId = '9063f63fe0e62eaa98316aeb214da1608e8a294666591a6664a8f5d5de2124fbi0';
                console.log(`Target inscription ID ${targetId} in clean_inscriptions.json: ${jsonIds.includes(targetId)}`);
            } catch (error) {
                console.error('JSON loading error:', error); // Debugging: Log error details
                resultsDiv.innerHTML = `<p class="text-orange-500">Warning: Error loading clean_inscriptions.json: ${error.message}. Displaying all inscriptions instead.</p>`;
                jsonIds = []; // Proceed without filtering if JSON fails
            }

            resultsDiv.innerHTML = '<p class="text-gray-500">Loading all Ordinals... This may take a moment.</p>';

            try {
                // Fetch all inscriptions with pagination
                while (true) {
                    const response = await fetch(`https://api.hiro.so/ordinals/v1/inscriptions?address=${encodeURIComponent(address)}&limit=${limit}&offset=${offset}`, {
                        headers: {
                            'Accept': 'application/json',
                            'Authorization': 'Bearer 1423e3815899d351c41529064e5b9a52'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    const inscriptions = data.results;

                    if (inscriptions.length === 0) {
                        break; // No more results to fetch
                    }

                    allInscriptions = allInscriptions.concat(inscriptions);
                    offset += limit;

                    // Update progress
                    resultsDiv.innerHTML = `<p class="text-gray-500">Loaded ${allInscriptions.length} Ordinals...</p>`;
                }

                // Check if the target inscription ID is in the fetched inscriptions
                const targetId = '9063f63fe0e62eaa98316aeb214da1608e8a294666591a6664a8f5d5de2124fbi0';
                const hasTargetId = allInscriptions.some(inscription => inscription.id === targetId);
                console.log(`Target inscription ID ${targetId} found in wallet: ${hasTargetId}`); // Debugging

                // Filter inscriptions if JSON loaded successfully, else show all
                const filteredInscriptions = jsonIds.length > 0
                    ? allInscriptions.filter(inscription => jsonIds.includes(inscription.id))
                    : allInscriptions;

                if (filteredInscriptions.length === 0) {
                    resultsDiv.innerHTML = `<p class="text-gray-500">No ${jsonIds.length > 0 ? 'matching Ordinals' : 'inscriptions'} found for this address${jsonIds.length > 0 ? ' in clean_inscriptions.json' : ''}.</p>`;
                    return;
                }

                let html = `<h2 class="text-xl font-semibold mb-4">${jsonIds.length > 0 ? 'Matching Ordinals' : 'All Inscriptions'} Found (${filteredInscriptions.length}):</h2><ul class="space-y-4 max-h-[600px] overflow-y-auto">`;
                for (const inscription of filteredInscriptions) {
                    html += `
                        <li class="border p-4 rounded-md">
                            <p><strong>Inscription ID:</strong> ${inscription.id}</p>
                            <p><strong>Number:</strong> ${inscription.number}</p>
                            <p><strong>Content Type:</strong> ${inscription.content_type}</p>
                            <p><strong>Sat Ordinal:</strong> ${inscription.sat_ordinal}</p>
                            <p><strong>Rarity:</strong> ${inscription.sat_rarity}</p>
                            <p><strong>Genesis Block:</strong> ${inscription.genesis_block_height}</p>
                            <a href="https://api.hiro.so/ordinals/v1/inscriptions/${inscription.id}/content" target="_blank" class="text-blue-500 hover:underline">View Content</a>
                        </li>
                    `;
                }
                html += '</ul>';
                resultsDiv.innerHTML = html;
            } catch (error) {
                console.error('API fetch error:', error); // Debugging: Log API errors
                resultsDiv.innerHTML = `<p class="text-red-500">Error fetching Ordinals: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>