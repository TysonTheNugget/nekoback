<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Image Randomizer and Bitcoin Payment Form</title>
    <script>
    let selectedBase64Image = "";
    
    function selectToInscribe() {
        const img = document.getElementById("randomImage");
        fetch(img.src)
        .then(response => response.blob())
        .then(blob => {
            const reader = new FileReader();
            reader.onload = function() {
                selectedBase64Image = reader.result;
                alert("Image selected for inscription.");
            }
            reader.readAsDataURL(blob);
        });
    }

    function randomizeImage() {
        fetch('/randomize', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            let uniqueTimestamp = new Date().getTime();
            document.getElementById('randomImage').src = data.imageUrl + '?' + uniqueTimestamp;
            document.getElementById('imageInfo').textContent = "Background: " + data.imageInfo.background +
            "\nBody: " + data.imageInfo.body + "\nBoost: " + data.imageInfo.boost + "\nMouth: " + data.imageInfo.mouth +
            "\nEyes: " + data.imageInfo.eyes + "\nFace: " + data.imageInfo.face + "\nBUN$/PB holdings: " + data.imageInfo.holdings +
            "\nATK: " + data.imageInfo.atk + " DEF: " + data.imageInfo.def + " SPEED: " + data.imageInfo.speed + " HP: +" + data.imageInfo.hp +
            "\nEffect: " + data.imageInfo.effect;
            document.getElementById('imageInfo').textContent += "\nFight Code: " + data.imageInfo.fightCode;
        });
    }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const submitButton = document.getElementById('submitButton');
            const resultDiv = document.getElementById('result');
            
            submitButton.addEventListener('click', function () {
                const receiveAddress = document.getElementById('receiveAddress').value;
                const feeRate = parseInt(document.getElementById('feeRate').value);
                const outputValue = parseInt(document.getElementById('outputValue').value);
                
                if (selectedBase64Image === "") {
                    alert('Please select an image for inscription.');
                    return;
                }
                
                const payload = {
                    receiveAddress,
                    feeRate,
                    outputValue,
                    files: [
                        {
                            filename: "my_selected_image.png",
                            dataURL: selectedBase64Image,
                        },
                    ],
                    devAddress: "bc1pra6pu30zu5ux72fs0jryh2ykt2zdqkcc2t7n98rrjpy70mnm3fcsxgd9xy",
                    devFee: 10600
                };
                
                resultDiv.innerText = JSON.stringify(payload, null, 2);
                
                const apiKey = '0c3bf50981aa4abd0dfd0b52315fdf527ab72750a527cb418bd21a649b825397';
                const apiUrl = 'https://open-api.unisat.io/v2/inscribe/order/create';
                const headers = {
                    "Authorization": `Bearer ${apiKey}`,
                    "Content-Type": "application/json"
                };
                
                fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload),
                })
                .then((response) => response.json())
                .then((data) => {
                    resultDiv.innerText += '\n\nResponse from Server:\n' + JSON.stringify(data, null, 2);
                });
            });
        });
    </script>
</head>
<body>
    <button onclick="randomizeImage()">Randomize</button>
    <button onclick="selectToInscribe()">Select to Inscribe</button>
    <img id="randomImage" src="/static/default.png" alt="Random Image" width="315" height="240">
    <pre id="imageInfo">Traits will appear here.</pre>
    <hr>
    <form id="paymentForm">
        <label for="receiveAddress">Receive Address:</label>
        <input type="text" id="receiveAddress"><br>
        <label for="feeRate">Fee Rate (sat/vByte):</label>
        <input type="number" id="feeRate" min="1" max="100" value="6"><br>
        <label for="outputValue">Output Value:</label>
        <input type="number" id="outputValue" value="546" readonly><br>
        <button type="button" id="submitButton">Submit</button>
    </form>
    <div id="result"></div>
</body>
</html>
